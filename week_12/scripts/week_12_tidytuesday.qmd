---
title: "Week 11 TidyTuesday"
author: "Jake"
format: html
date: today
toc: true
toc-depth: 4
fig-path: "../outputs/"
---

## Intro

Data is from TidyTuesday using data from the World Health Organization (WHO). It explores global tuberculosis (TB) burden estimates.

### Load Libraries
```{r}
#| message: false
#| warning: false

library(tidyverse)
library(here)
library(sf)
library(leaflet)
library(ggspatial)
library(ggiraph)
library(ggmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(prettymapr)
library(htmlwidgets) #save map

```

### Load data
```{r}
#| message: false
#| warning: false

who_tb_data <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-11-11/who_tb_data.csv')

```

### Data analysis
```{r}

#calculate year-over-year rate of change

who_tb_data <- who_tb_data %>% 
  arrange(country, year) %>% #set it up by country and year
  group_by(country, iso3) %>%  #make sure country and iso code are the grouping factor
  mutate(
    incidence_change = (e_inc_100k - lag(e_inc_100k)) / lag(e_inc_100k) * 100, #lag takes the previous value so you can calculat from one year to the next to get rate of change.
    death_change = (e_mort_exc_tbhiv_100k - lag(e_mort_exc_tbhiv_100k)) / lag(e_mort_exc_tbhiv_100k) * 100 #lag takes the previous value so you can calculat from one year to the next to get rate of change.
  )  %>% 
  ungroup()

#calculate the average annual rate of change across all the year for each country

tb_summary <- who_tb_data %>% 
  group_by(country, iso_numeric, iso3) %>% 
  summarise(
    ave_incidence_change = mean(incidence_change, na.rm = TRUE),
    ave_death_change = mean(death_change, na.rm = TRUE),
    total_incidence_change = (last(e_inc_100k) - first(e_inc_100k)) / first(e_inc_100k) * 100,
    total_death_change = (last(e_mort_exc_tbhiv_100k) - first(e_mort_exc_tbhiv_100k)) / first(e_mort_exc_tbhiv_100k) * 100,
    .groups = "drop"
  )
```


Something new I learned for this Tidy Tuesday was the lag function. It is helpful when you are trying to calulate the rate of change from one year to the next. The lag function takes the last value in the column. This allows you to run equations that that one row and subtract it from the previous row.

### Plotting a map
```{r}
#| warning: false
#| fig-align: "center"
#| label: fig-who
#| fig-cap: "This is a figure shows global tuberculosis (TB) burden estimates. When you hover over a country you can see the total incidence and death change from 2000 to 2023. The numbers are per 100,000 people. "

# Get world data
world <- ne_countries(scale = "medium", returnclass = "sf") #pull info for world map
world_tb <- world %>%
  left_join(tb_summary, by = c("iso_a3" = "iso3")) %>% #join data at the iso code
  mutate(
    tooltip = paste0(
      name, "\n",
      "Total Incidence Change: ", #title that will display for pop up box
      ifelse(is.na(total_incidence_change), "No data", #this is where the data will pull for the pop up box
             sprintf("%.2f", total_incidence_change)), "\n",
      "Total Death Change: ",  #title that will display for pop up box
      ifelse(is.na(total_death_change), "No data", 
             sprintf("%.2f",total_death_change)) #this is where the data will pull for the pop up box
    )
  )

# Create map with Stadia tiles
p <- ggplot(data = world_tb) +
  annotation_map_tile(
    type = "osm",  # Use open source map
    zoomin = 0,
    progress = "none"
  ) +
  geom_sf_interactive(
    aes(fill = iso_a3, tooltip = tooltip, data_id = iso_a3), #make each country a color
    color = "black",
    size = 0.2,
    alpha = 0.8
  ) +
  coord_sf(xlim = c(-180, 180), ylim = c(-60, 85), expand = FALSE) + #coordinate that will be displayed
  theme_minimal() +
  theme(
    legend.position = "none", #remove legend
    panel.grid = element_blank(), #remove grid lines
    axis.text = element_blank(), #no axis labels
    axis.title = element_blank() #no axis labels
  ) +
  labs(title = "Global TB Incidence and Death Total Change per 100,000 population",
       subtitle = "Data source: WWorld Health Organization (WHO)")

# Make interactive
interactive_map <- girafe(
  ggobj = p, 
  width_svg = 12, 
  height_svg = 7,
  options = list(
    opts_hover(css = "fill:cyan;stroke:black;stroke-width:2;"), #when you hover over it will make the country blue
    opts_tooltip(
      css = "background-color:white; 
             color:black;
             font-size:14px;
             padding:10px;
             border-radius:5px;
             border:2px solid black;
             font-family:Arial, sans-serif;", # all the features of the pop up box
      opacity = 0.95
    )
  )
)


#save map needs to be html if you want interactive
saveWidget(interactive_map, 
           here("week_12","outputs","tidy_tues_interactive_map.html"), 
           selfcontained = TRUE)
#see map
interactive_map

```

Another new thing I learned for this Tidy Tuesday was how to plot an interactive map (@fig-who). When you hover over a country a box will pop up showing the Total incidence and death changes. It also turns the country's color blue so you can see what you are highlighting. 